# **AWS ECR & ECS: Complete Image Push & Deployment Guide**  
*Step-by-Step Practical Instructions with Detailed Explanations*

---

## **1. Setting Up Elastic Container Registry (ECR)**

### **Step 1.1: Access AWS Console**
1. **Log in** to AWS Management Console using your IAM user credentials
2. In the top services search bar, type **"ECR"** (Elastic Container Registry)
3. Click on **"Elastic Container Registry"** from the results

### **Step 1.2: Create Repository**
1. Click **"Create repository"** button
2. **Repository Configuration**:
   - **Visibility settings**: Private (default)
   - **Repository name**: Enter a descriptive name (e.g., `my-web-app`)
   - **Tag immutability**: Enable (recommended for production) - prevents overwriting existing tags
   - **Scan on push**: Enable (optional, for security scanning)
3. Click **"Create repository"**

### **Step 1.3: Permission Troubleshooting**
**If you get "User not authorized" error:**

```text
Error Message: "User: arn:aws:iam::123456789012:user/dev-user 
is not authorized to perform: ecr:CreateRepository"
```

**Solution: Add Required IAM Permissions**

1. **Switch to Root Account** (temporarily) or ask your admin
2. Navigate to **IAM** → **User Groups** → Select your group (e.g., `EC2-Admins`)
3. Click **"Permissions"** tab → **"Add permissions"** → **"Attach policies"**
4. Search and select these policies:
   - **AmazonEC2ContainerRegistryFullAccess** (for ECR)
   - **AmazonECS_FullAccess** (for ECS)
5. Click **"Add permissions"**
6. **Switch back** to your IAM user account

---

## **2. AWS CLI Installation & Configuration**

### **Step 2.1: Install AWS CLI**

#### **For Windows:**
1. Download the **MSI installer** from:
   `https://awscli.amazonaws.com/AWSCLIV2.msi`
2. Run the installer (Administrator rights not required)
3. Follow the wizard (default settings are fine)
4. Verify installation:
   ```cmd
   aws --version
   # Should show: aws-cli/2.x.x Python/3.x.x Windows/10 exe/AMD64
   ```

#### **For macOS:**
```bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
```

#### **For Linux (Ubuntu):**
```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

### **Step 2.2: Get Access Keys**
1. **Log in as Root User** (one-time setup) or as IAM user with permissions
2. Go to **IAM** → **Users** → Select your IAM user (e.g., `dev-user`)
3. Click **"Security credentials"** tab
4. Scroll to **"Access keys"** section
5. Click **"Create access key"**
6. Choose **"Command Line Interface (CLI)"**
7. Check the confirmation box and click **"Next"**
8. **IMPORTANT**: Copy or download both:
   - **Access Key ID** (e.g., `AKIAIOSFODNN7EXAMPLE`)
   - **Secret Access Key** (e.g., `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`)
   
   ***Store these securely - you won't see the Secret Access Key again!***

### **Step 2.3: Configure AWS CLI**
1. Open **Terminal** (macOS/Linux) or **Command Prompt/PowerShell** (Windows)
2. Run configuration command:
   ```bash
   aws configure
   ```
3. Enter the following when prompted:
   ```
   AWS Access Key ID [None]: PASTE_YOUR_ACCESS_KEY_HERE
   AWS Secret Access Key [None]: PASTE_YOUR_SECRET_KEY_HERE
   Default region name [None]: ap-south-1  # or your preferred region
   Default output format [None]: json
   ```
   
   **Region Codes Reference:**
   - US East (N. Virginia): `us-east-1`
   - Asia Pacific (Mumbai): `ap-south-1`
   - Europe (Ireland): `eu-west-1`
   
   Check your AWS Console URL or go to top-right user menu → **Region**

4. **Verify Configuration:**
   ```bash
   aws sts get-caller-identity
   ```
   Should return your user ARN, account ID, and user ID

---

## **3. Preparing Docker Image for ECR**

### **Step 3.1: Understand Platform Compatibility**
**Problem**: You built Docker image on Windows/Mac (ARM architecture) but AWS EC2 uses **Linux/AMD64**.

**Solution**: Use Docker Buildx for cross-platform builds.

### **Step 3.2: Check Current Docker Setup**
```bash
# Check Docker version and buildx availability
docker --version
docker buildx version

# If buildx not available (older Docker), enable experimental features
# Or update Docker Desktop
```

### **Step 3.3: Create Cross-Platform Builder**
```bash
# Create and use a new builder instance that supports multiple platforms
docker buildx create --name mybuilder --use

# Verify the builder
docker buildx ls

# Expected output:
# NAME/NODE    DRIVER/ENDPOINT             STATUS  PLATFORMS
# mybuilder *  docker-container
#   mybuilder0 unix:///var/run/docker.sock running linux/amd64, linux/arm64, linux/arm/v7, linux/arm/v6
```

### **Step 3.4: Build for AWS-Compatible Platform**

#### **For Windows/Mac (ARM) to AWS (Linux/AMD64):**
```bash
# Navigate to your project directory containing Dockerfile
cd /path/to/your/project

# Build for Linux/AMD64 platform (AWS compatible)
docker buildx build --platform linux/amd64 -t my-web-app:latest . --load

# Command breakdown:
# --platform linux/amd64  → Target AWS EC2 architecture
# -t my-web-app:latest    → Tag the image (name:tag format)
# .                       → Build context (current directory with Dockerfile)
# --load                  → Load the built image into local Docker (for testing)
```

#### **For Linux (already AMD64):**
```bash
# Simple build (no cross-platform needed)
docker build -t my-web-app:latest .
```

### **Step 3.5: Test Locally (Optional but Recommended)**
```bash
# Run the container locally to verify it works
docker run -d -p 3000:3000 --name test-app my-web-app:latest

# Check if running
docker ps

# Check logs
docker logs test-app

# Test in browser: http://localhost:3000

# Stop and remove test container
docker stop test-app
docker rm test-app
```

---

## **4. Pushing Image to ECR**

### **Step 4.1: Get ECR Push Commands**
1. Go back to **AWS Console** → **ECR** → Your repository (`my-web-app`)
2. Click on repository name to open it
3. Click **"View push commands"** button
4. A modal will show 4 commands - **copy all of them**

### **Step 4.2: Execute Push Commands**

#### **Command 1: Authenticate Docker to ECR**
```bash
# Example command (your actual command will be different):
aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.ap-south-1.amazonaws.com

# What this does:
# 1. aws ecr get-login-password → Gets a temporary password from AWS
# 2. | docker login → Pipes that password to Docker login
# 3. --username AWS → Uses AWS as username (standard for ECR)
# 4. --password-stdin → Reads password from standard input
# 5. Registry URI → Your unique ECR registry URL
```

#### **Command 2: Build Tagged Image (Skip if Already Done)**
```bash
# If you haven't built/tagged your image yet:
docker build -t my-web-app:latest .

# But we already built with buildx, so we can skip or
# rebuild with regular docker if needed
```

#### **Command 3: Tag Your Image for ECR**
```bash
# Example command:
docker tag my-web-app:latest 123456789012.dkr.ecr.ap-south-1.amazonaws.com/my-web-app:latest

# What this does:
# Creates a new tag pointing to your local image
# Format: docker tag SOURCE_IMAGE:TAG TARGET_IMAGE:TAG
# TARGET_IMAGE must match your ECR repository URI
```

#### **Command 4: Push Image to ECR**
```bash
# Example command:
docker push 123456789012.dkr.ecr.ap-south-1.amazonaws.com/my-web-app:latest

# What happens:
# 1. Docker uploads image layers to ECR
# 2. You'll see progress for each layer
# 3. Final output: Digest: sha256:... (unique identifier)
```

### **Step 4.3: Verify in ECR Console**
1. Refresh your ECR repository page
2. You should see:
   - **Image URI**: Copy this (needed for ECS)
   - **Image tag**: `latest`
   - **Image size**: Displayed
   - **Pushed at**: Timestamp
   - **Scan status**: (if enabled)

---

## **5. Setting Up ECS Cluster**

### **Step 5.1: Navigate to ECS**
1. In AWS Console, search for **"ECS"** (Elastic Container Service)
2. Click on **"Clusters"** in left sidebar
3. Click **"Create Cluster"**

### **Step 5.2: Cluster Configuration**
1. **Cluster name**: Enter name (e.g., `production-cluster`)
2. **Infrastructure**: Choose one:
   
   **Option A: AWS Fargate (Serverless) - Recommended for beginners**
   - No EC2 instances to manage
   - Pay for vCPU/memory used
   - Select **Fargate** checkbox
   
   **Option B: Amazon EC2 Instances**
   - More control, more management
   - Choose instance type
   - Configure VPC and networking
   
3. **Monitoring**: 
   - **CloudWatch Container Insights**: Enable (optional)
   - **Cost**: Small additional charge for enhanced metrics
   
4. Click **"Create"**
5. Wait 1-2 minutes for cluster creation

---

## **6. Creating Task Definition**

### **Step 6.1: Navigate to Task Definitions**
1. In ECS left sidebar, click **"Task Definitions"**
2. Click **"Create new task definition"**
3. Choose launch type:
   - **Fargate**: If using Fargate cluster
   - **EC2**: If using EC2 instances

### **Step 6.2: Configure Task Definition**

#### **Step 1: Task Definition Configuration**
- **Family**: `my-web-app-task` (unique name)
- **Task role**: None (for now)
- **Network mode**: `awsvpc` (required for Fargate)
- **Task execution role**: `ecsTaskExecutionRole` (if doesn't exist, create it)
- **Task memory**: `0.5 GB` (512 MB) for small apps
- **Task CPU**: `0.25 vCPU` (256 CPU units)

#### **Step 2: Container Definition**
Click **"Add container"**:
1. **Container name**: `web-app`
2. **Image**: Paste your **ECR Image URI** from Step 4.3
   Format: `123456789012.dkr.ecr.ap-south-1.amazonaws.com/my-web-app:latest`
3. **Port mappings**: Add mapping
   - **Container port**: `3000` (your app's port)
   - **Protocol**: `tcp`
4. **Environment variables**: Add if needed (e.g., `NODE_ENV=production`)
5. **Advanced configuration** (optional):
   - Health check commands
   - Log configuration (CloudWatch)
   - Resource limits

#### **Step 3: Create Task Definition**
1. Review all settings
2. Click **"Create"**

---

## **7. Complete Workflow Summary**

### **Quick Reference Commands:**
```bash
# 1. Build for AWS platform (from Windows/Mac ARM)
docker buildx create --name awsbuilder --use
docker buildx build --platform linux/amd64 -t myapp:latest . --load

# 2. Get ECR authentication token
aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin YOUR_ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com

# 3. Tag for ECR
docker tag myapp:latest YOUR_ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/myapp:latest

# 4. Push to ECR
docker push YOUR_ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/myapp:latest
```

---

## **8. Troubleshooting Common Issues**

### **Issue 1: "no basic auth credentials"**
**Error**: 
```bash
Error response from daemon: Get https://.../v2/: no basic auth credentials
```
**Solution**: Run authentication command again (Step 4.2, Command 1)

### **Issue 2: "denied: Your authorization token has expired"**
**Solution**: ECR tokens expire after 12 hours. Re-authenticate:
```bash
aws ecr get-login-password --region YOUR_REGION | docker login --username AWS --password-stdin YOUR_ACCOUNT.dkr.ecr.YOUR_REGION.amazonaws.com
```

### **Issue 3: "exec /bin/sh: exec format error"**
**Cause**: Built for wrong platform (ARM on AWS AMD64)
**Solution**: Use buildx with `--platform linux/amd64`

### **Issue 4: AWS CLI "Unable to locate credentials"**
**Solution**: 
```bash
# Check current configuration
aws configure list

# Reconfigure
aws configure
# Or set environment variables
export AWS_ACCESS_KEY_ID="YOUR_KEY"
export AWS_SECRET_ACCESS_KEY="YOUR_SECRET"
```

---

## **9. Next Steps: Running Your Container**

After successful image push to ECR:
1. **Create ECS Service** → Uses Task Definition
2. **Configure Load Balancer** (ALB) for public access
3. **Set up Auto Scaling** for multiple instances
4. **Configure CloudWatch Logs** for monitoring

---

## **10. Cleanup Commands (When Done Testing)**

```bash
# Remove local Docker image
docker rmi my-web-app:latest
docker rmi YOUR_ACCOUNT.dkr.ecr.region.amazonaws.com/my-web-app:latest

# Remove builder
docker buildx rm mybuilder

# Delete ECR repository (via AWS Console or CLI):
aws ecr delete-repository --repository-name my-web-app --force

# Delete ECS task definition (via AWS Console)
```

**Success Checklist**: 
- [ ] Image successfully pushed to ECR
- [ ] Image appears in ECR repository
- [ ] Task definition created with correct image URI
- [ ] Can create ECS service using this task definition

**Pro Tip**: Always test with a small "Hello World" image first before pushing your actual application image.