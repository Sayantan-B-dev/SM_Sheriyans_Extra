```markdown
▶ AWS S3 Setup (Continuation – 04.04)
➡️ inside `music-service/`
```

```markdown
▶ AWS SDK Reference
➡️ search: `aws sdk s3 v3 js docs`
➡️ open **Hello Amazon S3**
➡️ we will use: `@aws-sdk/client-s3`
```

```markdown
▶ Install AWS S3 SDK
➡️ npm i @aws-sdk/client-s3
```

```markdown
▶ Storage Service File
➡️ create `/src/services/storage.service.js`
➡️ import `S3Client` and `PutObjectCommand` from `@aws-sdk/client-s3`
   // S3Client → main client to communicate with AWS S3
   // PutObjectCommand → uploads files (objects) to S3
```

```markdown
▶ AWS IAM Permission
➡️ go to AWS console (root)
➡️ select the user group used for this project
➡️ attach permission: `AmazonS3FullAccess`
   // allows upload, read, and management of S3 objects
```

```markdown
▶ Create S3 Bucket
➡️ AWS console → Storage → S3
➡️ create bucket
➡️ give bucket a unique name

➡️ keep **Block all public access = ON**
   // prevents accidental public exposure
   // enforces access via signed URLs
   // improves security and control

➡️ create bucket
➡️ go to bucket → Properties
```

```markdown
▶ AWS Environment Variables
➡️ back to `.env`
➡️ add:
   - AWS_REGION
   - AWS_ACCESS_KEY_ID
   - AWS_SECRET_ACCESS_KEY
```

```markdown
▶ Configure S3 Client
➡️ back to `storage.service.js`
➡️ import `config`
➡️ create S3 instance:

new S3Client({
  region: config.AWS_REGION,
  credentials: {
    accessKeyId: config.AWS_ACCESS_KEY_ID,
    secretAccessKey: config.AWS_SECRET_ACCESS_KEY
  }
})

   // region → bucket location
   // credentials → IAM authentication
```

```markdown
▶ UUID for File Naming
➡️ npm i uuid
➡️ import `{ v4 as uuidv4 }`
   // guarantees unique file keys
```

```markdown
▶ File Upload Function
➡️ create async function `uploadFile(file)`
➡️ generate key using `uuid + original filename`
➡️ create `PutObjectCommand` with:
   - Bucket
   - Body (file buffer)
   - Key

➡️ await `s3.send(command)`
➡️ return the key
```

```markdown
▶ Music Controller
➡️ create `src/controllers/music.controller.js`
➡️ import:
   - uploadFile (storage service)
   - musicModel (models)

➡️ create `uploadMusic` controller
➡️ update model fields:
   - musicURL → musicKey
   - coverImageURL → coverImageKey

➡️ ensure auth-service JWT stores `fullName`
```

```markdown
▶ Multer Setup
➡️ npm i multer
➡️ go to `music.routes.js`
➡️ import multer

➡️ create upload instance:
   multer({ storage: multer.memoryStorage() })
   // stores files in RAM
   // ideal for immediate S3 uploads
   // avoids disk I/O
```

```markdown
▶ Upload Route
➡️ router.post('/upload', ...)
➡️ use upload.fields([
     { name: 'music', maxCount: 1 },
     { name: 'coverImage', maxCount: 1 }
   ])
```

```markdown
▶ Controller Binding
➡️ in `music.routes.js`
➡️ import * as musicController
➡️ after upload middleware, call `musicController.uploadMusic`
```

```markdown
▶ Handle Files in Controller
➡️ in `music.controller.js`
➡️ inside `uploadMusic`:
   - const musicFile = req.files['music'][0]
   - const coverImageFile = req.files['coverImage'][0]

➡️ wrap logic in try–catch
➡️ upload both files
➡️ create DB entry
➡️ send response
```

```markdown
▶ Auth Middleware (Music Service)
➡️ create `src/middlewares/auth.middleware.js`
➡️ import jwt and config
   // must match auth-service JWT secret

➡️ create `authArtistMiddleware(req,res,next)`
➡️ extract token from `req.cookies.token`
➡️ if missing → 401 Unauthorized

➡️ verify token using jwt.verify
➡️ if role !== artist → 403 Forbidden
➡️ attach decoded user to req.user
➡️ next()
```

```markdown
▶ Apply Middleware
➡️ import auth middleware in routes
➡️ use it where artist-only access is required
```

```markdown
▶ Auth Service Check
➡️ in auth-service `auth.controller.js`
➡️ ensure register:
   - accepts role from req.body
   - stores role in user
➡️ test via Postman
```

```markdown
▶ Service Ports
➡️ auth-service → 3000
➡️ notification-service → 3001
➡️ music-service → 3002
```

```markdown
▶ Artist Name Safety
➡️ if artist is undefined:
➡️ while creating music record use:
   - req.user.fullName.firstname
   - req.user.fullName.lastname
```

```markdown
▶ S3 Object Access
➡️ files visible in bucket
➡️ direct object URL fails
➡️ bucket is private
➡️ solution → presigned URLs
```

```markdown
▶ Presigned URL Docs
➡️ revisit AWS docs:
   Create a presigned URL
➡️ install:
   npm i @aws-sdk/s3-request-presigner
```

```markdown
▶ Presigned URL Service
➡️ in `storage.service.js`
➡️ import:
   - GetObjectCommand
   - getSignedUrl

➡️ create function `getPresignedUrl(key)`
➡️ create GetObjectCommand with bucket + key
➡️ generate URL with expiration
➡️ return URL
```

```markdown
▶ Fetch Artist Musics
➡️ in `music.controller.js`
➡️ import getPresignedUrl
➡️ create `getArtistMusics(req,res)`

➡️ query:
   musicModel.find({ artistId: req.user.id }).lean()

➡️ why `.lean()`:
   // returns plain JS objects
   // faster reads
   // lower memory usage
   // ideal for bulk fetch

➡️ loop results:
   - music.musicUrl = await getPresignedUrl(music.musicKey)
   - music.coverImageUrl = await getPresignedUrl(music.coverImageKey)

➡️ return array with status 200
```

```markdown
▶ Artist Music Route
➡️ in `music.routes.js`
➡️ create GET `/artist-musics`
➡️ use authArtistMiddleware
➡️ call getArtistMusics controller
```
