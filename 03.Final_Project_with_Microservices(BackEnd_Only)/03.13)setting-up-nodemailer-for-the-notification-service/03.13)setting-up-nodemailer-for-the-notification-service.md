read https://github.com/ankurdotio/Difference-Backend-video/tree/main/026-nodemailer

1. **Install Nodemailer:**

   ```bash
   npm install nodemailer
   ```

2. **Install dotenv (for environment variables):**

   ```bash
   npm install dotenv
   ```

## Configuration

### 1. Create a `.env` File

Create a `.env` file in the root of your project to securely store your OAuth2 credentials:

```env
CLIENT_ID=your-client-id
CLIENT_SECRET=your-client-secret
REFRESH_TOKEN=your-refresh-token
EMAIL_USER=your-email@example.com
```

Replace the placeholders with your actual OAuth2 credentials and the refresh token obtained from the OAuth 2.0 Playground.

### 2. Set Up Nodemailer with OAuth2

Create a new file `email.js` and set up the Nodemailer transporter with OAuth2:

```javascript
require('dotenv').config();
const nodemailer = require('nodemailer');

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    type: 'OAuth2',
    user: process.env.EMAIL_USER,
    clientId: process.env.CLIENT_ID,
    clientSecret: process.env.CLIENT_SECRET,
    refreshToken: process.env.REFRESH_TOKEN,
  },
});

// Verify the connection configuration
transporter.verify((error, success) => {
  if (error) {
    console.error('Error connecting to email server:', error);
  } else {
    console.log('Email server is ready to send messages');
  }
});

module.exports = transporter;
```

### 3. Create a Function to Send Emails

In the same `email.js` file, add a function to send emails:

```javascript
// Function to send email
const sendEmail = async (to, subject, text, html) => {
  try {
    const info = await transporter.sendMail({
      from: `"Your Name" <${process.env.EMAIL_USER}>`, // sender address
      to, // list of receivers
      subject, // Subject line
      text, // plain text body
      html, // html body
    });

    console.log('Message sent: %s', info.messageId);
    console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
  } catch (error) {
    console.error('Error sending email:', error);
  }
};

module.exports = sendEmail;
```

### 4. Use the Email Function in Your Application

In your main application file (e.g., `app.js`), import the `sendEmail` function and use it to send emails:

```javascript
const sendEmail = require('./email');

// Example usage
sendEmail(
  'recipient@example.com',
  'Test Email Subject',
  'This is a test email sent with Nodemailer using OAuth2.',
  '<p>This is a test email sent with <b>Nodemailer</b> using OAuth2.</p>'
);
```

## Running the Application

To send an email, simply run your Node.js application:

```bash
node app.js
```

If everything is configured correctly, you should see a message in your console indicating that the email was sent successfully.

## Troubleshooting

- **Invalid Credentials Error**: Ensure that your `ClientID`, `ClientSecret`, and `RefreshToken` are correct and match the Google account associated with `EMAIL_USER`.
- **Email Not Sent**: Check if the OAuth2 scopes include Gmail API access and if the `RefreshToken` has the necessary permissions.

## References

- [Nodemailer Documentation](https://nodemailer.com/about/)
- [Google OAuth2 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [OAuth 2.0 Playground](https://developers.google.com/oauthplayground)

## 1ï¸âƒ£ What problem this setup is solving (core idea)

Google **does NOT allow**:

* Username + password login for apps anymore
* â€œLess secure app accessâ€ is deprecated

So if your Node.js app wants to send emails **from a Gmail account**, you must:

* Prove your identity to Google
* Get permission **without exposing your Gmail password**
* Renew that permission automatically

Thatâ€™s exactly what **OAuth2 + Nodemailer** does.

---

## 2ï¸âƒ£ High-level architecture (mental model)

```
Your Node App
   |
   | (OAuth2 credentials + refresh token)
   v
Google OAuth Server
   |
   | (temporary access token)
   v
Gmail SMTP / Gmail API
   |
   v
Recipient Inbox
```

Your app **never logs in** to Gmail directly.
It **borrows permission** from Google.

---

## 3ï¸âƒ£ Why OAuth2 is required here

OAuth2 gives you:

* âœ… No password storage
* âœ… Revocable access
* âœ… Time-limited access tokens
* âœ… Long-term refresh token

### Tokens involved

| Token         | Lifetime   | Purpose                       |
| ------------- | ---------- | ----------------------------- |
| Access Token  | ~1 hour    | Used to actually send email   |
| Refresh Token | Long-lived | Used to get new access tokens |

ðŸ‘‰ **Nodemailer automatically uses the refresh token to fetch access tokens**, so your app runs continuously without re-auth.

---

## 4ï¸âƒ£ Google Cloud setup â€” why each step matters

### Create a Google Cloud Project

* OAuth credentials must belong to **a project**
* Project = security + quota boundary

### Enable Gmail API

* Without this, Google will refuse email-sending scopes
* Gmail is treated like a protected API

### Create OAuth 2.0 Client

You choose **Web Application** because:

* OAuth Playground simulates a web redirect
* Google enforces redirect URI validation

### Authorized Redirect URIs

These URIs tell Google:

> â€œOnly redirect tokens to these trusted URLsâ€

Thatâ€™s why you add:

* `http://localhost`
* `https://developers.google.com/oauthplayground`

Without this â†’ **token exchange fails**

---

## 5ï¸âƒ£ OAuth 2.0 Playground â€” why itâ€™s used

Your Node app is **not a user-facing OAuth app**.
You donâ€™t want users logging in via Google just to send email.

So the Playground is used to:

* Manually authorize once
* Generate a **refresh token**
* Copy it into `.env`

Think of this as:

> â€œOne-time consent generationâ€

---

## 6ï¸âƒ£ Why `access_type = offline` is critical

If you **donâ€™t set Offline access**:

* Google gives only an access token
* Token expires in ~1 hour
* Your app breaks

Offline access = **refresh token is issued**

This is the single most important setting.

---

## 7ï¸âƒ£ Why the scope is `https://mail.google.com/`

Scopes define **what your app can do**.

This scope allows:

* Sending emails
* Reading mailbox
* Full Gmail access

Itâ€™s broad but reliable.

If you choose smaller scopes incorrectly:

* Nodemailer may fail silently
* Gmail may reject SMTP access

---

## 8ï¸âƒ£ Why `.env` is used (security reason)

These values are **secrets**:

* CLIENT_ID
* CLIENT_SECRET
* REFRESH_TOKEN

They must:

* âŒ Never be committed to Git
* âŒ Never be logged
* âœ… Be injected at runtime

`.env` ensures:

* Different values per environment
* Easy rotation if compromised

---

## 9ï¸âƒ£ Nodemailer transporter â€” what it actually does

The transporter is **not a connection**.
Itâ€™s a **configuration + capability object**.

What Nodemailer does internally:

1. Uses refresh token â†’ requests access token from Google
2. Opens SMTP connection to Gmail
3. Authenticates using OAuth2
4. Sends email
5. Closes connection

You never see these steps â€” Nodemailer abstracts them.

---

## ðŸ”Ÿ Why `transporter.verify()` exists

This is a **sanity check**, not required.

It verifies:

* OAuth credentials are valid
* Gmail is reachable
* Authentication will work

Best used:

* On server startup
* During deployment
* During debugging

---

## 1ï¸âƒ£1ï¸âƒ£ `sendEmail()` function â€” conceptual role

This function is a **thin abstraction**:

* Hides Nodemailer details
* Centralizes email formatting
* Makes email sending reusable

This is important because later you can:

* Add templates
* Add retry logic
* Add logging
* Switch providers (SES / SendGrid)

Without changing business logic.

---

## 1ï¸âƒ£2ï¸âƒ£ Why both `text` and `html` exist

Email clients behave differently:

* Some block HTML
* Some prefer text previews

Best practice:

* Always send both
* Client chooses what to display

---

## 1ï¸âƒ£3ï¸âƒ£ Why this works reliably in production (and limits)

### Works well for:

* Personal projects
* Small apps
* Admin alerts
* Low-volume transactional email

### NOT suitable for:

* Bulk marketing
* OTP floods
* Large-scale notifications

Because:

* Gmail has strict sending limits
* OAuth tokens can be revoked
* Deliverability is weaker than dedicated providers

---

## 1ï¸âƒ£4ï¸âƒ£ Real-world failure cases you should expect

| Issue                       | Why it happens                     |
| --------------------------- | ---------------------------------- |
| Refresh token stops working | User revoked access                |
| `invalid_grant` error       | Wrong redirect URI / expired token |
| Emails not delivered        | Gmail quota exceeded               |
| Works locally but not prod  | ENV vars missing                   |

This is normal behavior, not misconfiguration.

---

## 1ï¸âƒ£5ï¸âƒ£ Big takeaway (remember this)

> **Nodemailer is not authentication.
> OAuth2 is not email.
> Together, they create secure delegated email sending.**

Or simply:

> **OAuth2 proves who you are
> Nodemailer sends on your behalf**

---