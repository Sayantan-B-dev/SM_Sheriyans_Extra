## `src/app.js`

```text
ORDER SERVICE APP INITIALIZATION ALGORITHM:
â†’ import express and cookie-parser
â†’ import order routes
â†’ create express app instance
â†’ enable JSON body parsing
â†’ enable cookie parsing
â†’ define GET / health-check route
    â†’ return 200 with "Order service is running"
â†’ mount order routes at /api/orders
â†’ export app instance
```

---

## `src/db/db.js`

```text
DATABASE CONNECTION ALGORITHM:
â†’ import mongoose
â†’ define async connectDB function
â†’ attempt mongoose.connect using MONGO_URI
â†’ on success: log connection message
â†’ on failure: log error
â†’ export connectDB
```

---

## `src/broker/borker.js`

```text
MESSAGE BROKER CONNECTION ALGORITHM:
â†’ import amqplib
â†’ define shared connection and channel variables

CONNECT():
â†’ if connection already exists, return it
â†’ connect to RabbitMQ using RABBIT_URL
â†’ create channel
â†’ handle connection errors

PUBLISH TO QUEUE ALGORITHM:
â†’ ensure broker connection exists
â†’ assert queue with durable=true
â†’ stringify payload
â†’ send message to queue
â†’ log published message

SUBSCRIBE TO QUEUE ALGORITHM:
â†’ ensure broker connection exists
â†’ assert queue
â†’ consume messages
â†’ parse message JSON
â†’ execute callback with data
â†’ acknowledge message

â†’ export connect, publishToQueue, subscribeToQueue
```

---

## `src/models/order.model.js`

```text
ORDER SCHEMA DESIGN ALGORITHM:
â†’ define reusable address schema
â†’ define order schema with:
    â†’ user (ObjectId, required)
    â†’ items array:
        â†’ product (ObjectId)
        â†’ quantity (number â‰¥ 1)
        â†’ price:
            â†’ amount (number)
            â†’ currency (USD | INR)
    â†’ status enum:
        â†’ PENDING
        â†’ CONFIRMED
        â†’ CANCELLED
        â†’ SHIPPED
        â†’ DELIVERED
    â†’ totalPrice:
        â†’ amount
        â†’ currency
    â†’ shippingAddress (embedded address schema)
â†’ enable timestamps
â†’ create and export order model
```

---

## `src/middlewares/auth.middleware.js`

```text
AUTHENTICATION & AUTHORIZATION ALGORITHM:
â†’ accept allowed roles array (default: user)
â†’ extract token from:
    â†’ cookie OR Authorization header
â†’ if token missing:
    â†’ return 401 Unauthorized
â†’ verify JWT using JWT_SECRET
â†’ if role not allowed:
    â†’ return 403 Forbidden
â†’ attach decoded user to req.user
â†’ call next middleware
â†’ on token error:
    â†’ return 401 Invalid token
```

---

## `src/middlewares/validation.middleware.js`

```text
CREATE ORDER VALIDATION ALGORITHM:
â†’ validate shippingAddress fields:
    â†’ street, city, state, country: non-empty strings
    â†’ pincode: numeric string (â‰¥ 4 digits)
â†’ collect validation errors
â†’ if errors exist:
    â†’ return 400 with error array
â†’ otherwise proceed

UPDATE ADDRESS VALIDATION ALGORITHM:
â†’ validate all address fields as non-empty strings
â†’ validate pincode format
â†’ handle validation result
```

---

## `src/routes/order.routes.js`

```text
ORDER ROUTING ALGORITHM:
â†’ POST /api/orders
    â†’ authenticate user
    â†’ validate shipping address
    â†’ call createOrder

â†’ GET /api/orders/me
    â†’ authenticate user
    â†’ call getMyOrders

â†’ POST /api/orders/:id/cancel
    â†’ authenticate user
    â†’ call cancelOrderById

â†’ PATCH /api/orders/:id/address
    â†’ authenticate user
    â†’ validate address
    â†’ call updateOrderAddress

â†’ GET /api/orders/:id
    â†’ authenticate user or admin
    â†’ call getOrderById
```

---

## `src/controllers/order.controller.js`

---

### `createOrder`

```text
CREATE ORDER ALGORITHM:
â†’ extract authenticated user
â†’ extract JWT token (cookie or header)

â†’ call Cart Service:
    â†’ GET /api/cart with Authorization header

â†’ for each cart item:
    â†’ fetch product details from Product Service
    â†’ collect product data in parallel (Promise.all)

â†’ initialize totalPrice = 0
â†’ for each cart item:
    â†’ find matching product
    â†’ if stock < requested quantity:
        â†’ throw error
    â†’ calculate item total price
    â†’ accumulate order total
    â†’ construct order item object

â†’ create order document:
    â†’ user id
    â†’ order items
    â†’ status = PENDING
    â†’ total price
    â†’ shipping address

â†’ publish ORDER_CREATED event to seller dashboard queue
â†’ return 201 with order
â†’ on failure:
    â†’ return 500 Internal Server Error
```

---

### `getMyOrders`

```text
GET USER ORDERS ALGORITHM:
â†’ extract authenticated user
â†’ parse page & limit from query
â†’ calculate skip value

â†’ query orders by user id
â†’ apply pagination (skip & limit)
â†’ count total orders

â†’ return orders with pagination metadata
â†’ on failure:
    â†’ return 500
```

---

### `getOrderById`

```text
GET ORDER BY ID ALGORITHM:
â†’ extract user and orderId
â†’ find order by ID
â†’ if not found:
    â†’ return 404
â†’ if order.user â‰  authenticated user:
    â†’ return 403
â†’ return order
â†’ on failure:
    â†’ return 500
```

---

### `cancelOrderById`

```text
CANCEL ORDER ALGORITHM:
â†’ extract user and orderId
â†’ find order by ID
â†’ if not found:
    â†’ return 404
â†’ if user does not own order:
    â†’ return 403
â†’ if order status â‰  PENDING:
    â†’ return 409 Conflict
â†’ update status to CANCELLED
â†’ save order
â†’ return updated order
â†’ on failure:
    â†’ return 500
```

---

### `updateOrderAddress`

```text
UPDATE ORDER ADDRESS ALGORITHM:
â†’ extract user and orderId
â†’ find order by ID
â†’ if not found:
    â†’ return 404
â†’ if user does not own order:
    â†’ return 403
â†’ if order status â‰  PENDING:
    â†’ return 409 Conflict
â†’ replace shipping address
â†’ save order
â†’ return updated order
â†’ on failure:
    â†’ return 500
```

---

## PART 1 â€” HOW THIS TEST SYSTEM WORKS (MENTAL MODEL)

### 1ï¸âƒ£ What `describe()` actually means

```js
describe('POST /api/orders/:id/cancel â€” Buyer-initiated cancel while rules apply', () => { ... })
```

**Think of `describe` as a folder / scope**

```text
DESCRIBE BLOCK:
â†’ Groups related test cases
â†’ Gives context to all nested tests
â†’ Can contain hooks (beforeEach, afterEach)
â†’ Can be nested
```

It **does NOT execute logic itself** â€” it only **organizes tests**.

---

### 2ï¸âƒ£ What `it()` / `test()` means

```js
it('cancels a PENDING order and returns updated order', async () => { ... })
```

`it` and `test` are the **same thing**.

```text
IT BLOCK:
â†’ Defines ONE test scenario
â†’ Must be independent
â†’ Jest runs each it() in isolation
â†’ Async allowed
â†’ If expectations fail â†’ test fails
```

Think:

```text
ONE it() = ONE behavior guarantee
```

---

### 3ï¸âƒ£ What `beforeEach()` does

```js
beforeEach(async () => {
  await orderModel.deleteMany({});
});
```

```text
BEFORE EACH TEST:
â†’ Runs before EVERY it()
â†’ Used to reset database / mocks
â†’ Prevents test pollution
â†’ Ensures deterministic results
```

Without this, **tests would randomly fail**.

---

### 4ï¸âƒ£ Why Supertest is used

```js
const request = require('supertest');
```

Supertest allows you to:

```text
â†’ Start Express app in memory
â†’ Send HTTP requests without real server
â†’ Assert HTTP status, headers, body
```

This line:

```js
request(app)
```

means:

```text
â†’ Use Express app directly
â†’ No port
â†’ No network
â†’ Fast + isolated
```

---

### 5ï¸âƒ£ How authentication is faked (VERY IMPORTANT)

```js
.set('Cookie', getAuthCookie())
```

From `tests/setup/auth.js`:

```text
AUTH COOKIE ALGORITHM:
â†’ create JWT payload { id, role }
â†’ sign with test secret
â†’ return ["token=<JWT>"]
â†’ Supertest attaches cookie to request
â†’ auth middleware decodes it
â†’ req.user is populated
```

This avoids **real login calls**.

---

### 6ï¸âƒ£ Why MongoMemoryServer is used

From `tests/setup/mongodb.js`:

```text
IN-MEMORY DB FLOW:
â†’ Start fake MongoDB in RAM
â†’ Override MONGO_URI
â†’ Connect mongoose
â†’ Clear collections before each test
â†’ Destroy DB after tests
```

This ensures:

```text
â†’ No real database touched
â†’ Tests are fast
â†’ Tests are repeatable
```

---

## PART 2 â€” ALGORITHMIC TEST CASES (YOUR FORMAT)

Now the **core part you want**.

---

## ğŸ“Œ cancelOrder.test.js

### `POST /api/orders/:id/cancel`

---

### âœ… Test 1 â€” Cancel PENDING order

```text
CANCEL ORDER (SUCCESS) TEST ALGORITHM:
â†’ clear orders collection
â†’ insert order with:
    â†’ status = PENDING
    â†’ user = authenticated user
â†’ send POST /orders/:id/cancel
â†’ attach valid auth cookie
â†’ expect HTTP 200
â†’ extract order from response
â†’ assert order.status = CANCELLED
```

---

### âŒ Test 2 â€” Cancel SHIPPED / DELIVERED order

```text
CANCEL ORDER (INVALID STATUS) TEST ALGORITHM:
â†’ insert order with status = SHIPPED
â†’ send cancel request as owner
â†’ expect HTTP 409 Conflict
â†’ expect error message about cancellation not allowed
```

---

### âŒ Test 3 â€” Cancel order owned by another user

```text
CANCEL ORDER (NOT OWNER) TEST ALGORITHM:
â†’ insert order with user A
â†’ authenticate as user B
â†’ send cancel request
â†’ expect HTTP 403 Forbidden
â†’ expect ownership error message
```

---

## ğŸ“Œ createOrder.test.js

### `POST /api/orders`

---

### âœ… Create order successfully

```text
CREATE ORDER (SUCCESS) TEST ALGORITHM:
â†’ authenticate user
â†’ send POST /orders with shipping address
â†’ expect HTTP 201 Created
â†’ expect order object in response
â†’ assert:
    â†’ status = PENDING
    â†’ items copied from cart
    â†’ totalPrice computed
    â†’ shippingAddress saved
```

---

### âŒ Missing address

```text
CREATE ORDER (INVALID INPUT) TEST ALGORITHM:
â†’ authenticate user
â†’ send POST /orders with empty body
â†’ expect HTTP 400
â†’ expect validation errors
```

---

## ğŸ“Œ getMyOrders.test.js

### `GET /api/orders/me`

---

### âœ… Default pagination

```text
GET MY ORDERS (DEFAULT PAGINATION):
â†’ authenticate user
â†’ send GET /orders/me
â†’ expect HTTP 200
â†’ expect array of orders
â†’ expect pagination meta:
    â†’ page defaults to 1
    â†’ limit defaults to 20
```

---

### âœ… Custom pagination

```text
GET MY ORDERS (CUSTOM PAGINATION):
â†’ send GET /orders/me?page=2&limit=5
â†’ expect meta.page = 2
â†’ expect meta.limit = 5
```

---

### âœ… No orders case

```text
GET MY ORDERS (EMPTY RESULT):
â†’ authenticate user with no orders
â†’ send GET /orders/me
â†’ expect empty array
```

---

## ğŸ“Œ getOrderById.test.js

### `GET /api/orders/:id`

---

### âœ… Order exists

```text
GET ORDER BY ID (SUCCESS):
â†’ check order exists
â†’ send GET /orders/:id
â†’ expect HTTP 200
â†’ expect:
    â†’ items array
    â†’ status
    â†’ totalPrice
    â†’ shippingAddress
    â†’ timeline array
    â†’ payment summary
```

---

### âŒ Order not found

```text
GET ORDER BY ID (NOT FOUND):
â†’ send request with fake ObjectId
â†’ expect HTTP 404
â†’ expect not found message
```

---

## ğŸ“Œ updateAddress.test.js

### `PATCH /api/orders/:id/address`

---

### âœ… Update address (allowed)

```text
UPDATE ADDRESS (SUCCESS):
â†’ insert PENDING order owned by user
â†’ send PATCH with new address
â†’ expect HTTP 200
â†’ expect shippingAddress updated
```

---

### âŒ Address update after shipping

```text
UPDATE ADDRESS (INVALID STATUS):
â†’ insert order with status = SHIPPED
â†’ send PATCH request
â†’ expect HTTP 409 Conflict
```

---

### âŒ Invalid address

```text
UPDATE ADDRESS (VALIDATION FAIL):
â†’ insert PENDING order
â†’ send PATCH with incomplete address
â†’ expect HTTP 400
```

---

## PART 3 â€” BIG PICTURE (WHY THIS IS GOOD)

This test suite ensures:

```text
âœ“ Authorization rules
âœ“ Ownership checks
âœ“ State machine correctness
âœ“ Validation enforcement
âœ“ Pagination behavior
âœ“ Safe DB isolation
```

This is **production-grade backend testing** â€” not toy examples.

---