# Product Service – Detailed Technical Documentation

This service implements **product management** for an e-commerce–like system using **Node.js, Express, MongoDB, JWT auth, ImageKit, and Jest**.
It is designed to be **stateless**, **role-aware**, **testable**, and **scalable**.

---

## 1. Project Initialization

### 1.1 Initialize Node Project

```bash
npm init -y
```

Creates a baseline `package.json` with default metadata.

---

### 1.2 Install Runtime Dependencies

```bash
npm i express mongoose dotenv cookie-parser jsonwebtoken multer imagekit uuid express-validator
```

#### Why each dependency exists

| Package             | Purpose                             |
| ------------------- | ----------------------------------- |
| `express`           | HTTP server & routing               |
| `mongoose`          | MongoDB ODM                         |
| `dotenv`            | Environment variable loading        |
| `cookie-parser`     | Read JWT from cookies               |
| `jsonwebtoken`      | Token verification                  |
| `multer`            | Multipart/form-data (image uploads) |
| `imagekit`          | External image storage              |
| `uuid`              | Unique image filenames              |
| `express-validator` | Request validation                  |

---

### 1.3 Install Dev Dependencies

```bash
npm i -D nodemon jest supertest mongodb-memory-server
```

| Package                 | Purpose                     |
| ----------------------- | --------------------------- |
| `nodemon`               | Dev hot reload              |
| `jest`                  | Test runner                 |
| `supertest`             | HTTP assertions             |
| `mongodb-memory-server` | In-memory MongoDB for tests |

---

## 2. Directory Structure (Strict Layered Architecture)

```text
root/
├── server.js                # Application bootstrap
├── package.json
├── .env
├── src/
│   ├── app.js               # Express app configuration
│   ├── db/
│   │   └── db.js            # MongoDB connection
│   ├── models/
│   │   └── product.model.js # Mongoose schema
│   ├── routes/
│   │   └── product.routes.js
│   ├── controllers/
│   │   └── product.controller.js
│   ├── middlewares/
│   │   └── auth.middleware.js
│   ├── validators/
│   │   └── product.validators.js
│   ├── services/
│   │   └── imagekit.service.js
│   └── broker/
│       └── borker.js        # Event/message broker
└── test/
    └── setup.js             # Jest global setup
```

**Rule:**
Each layer only talks to **adjacent layers**, never skipping.

---

## 3. Express Application Layer

### 3.1 `src/app.js`

#### Purpose

Creates and configures the Express application **without starting the server**.

#### Required Imports

```js
const express = require('express');
const cookieParser = require('cookie-parser');
const productRoutes = require('./routes/product.routes');
```

#### Responsibilities

* Initialize Express
* Register middleware
* Mount routes
* Export `app` instance

#### Design Reason

Keeping `app.js` server-agnostic allows:

* Easy testing with Supertest
* Multiple server entry points
* Clean separation of concerns

---

## 4. Server Bootstrap

### 4.1 `server.js`

#### Required Imports

```js
require('dotenv').config();
const app = require('./src/app');
const connectDB = require('./src/db/db');
const { connect } = require("./src/broker/borker");
```

#### Responsibilities

1. Load environment variables
2. Connect MongoDB
3. Connect broker (Redis / RabbitMQ / etc.)
4. Start HTTP listener

#### Important Rule

> ❌ **No Express config here**
> ✅ Only orchestration

---

## 5. Database Layer

### 5.1 `src/db/db.js`

#### Required Import

```js
const mongoose = require('mongoose');
```

#### Responsibilities

* Establish MongoDB connection
* Handle connection errors
* Export reusable `connectDB()` function

#### Connection Rules

* Uses `process.env.MONGO_URI`
* Must be awaited before server start
* Safe for reuse in tests

---

## 6. Environment Configuration

### 6.1 `.env`

```env
MONGO_URI=
JWT_SECRET=

REDIS_HOST=
REDIS_PORT=
REDIS_PASSWORD=

IMAGEKIT_PUBLIC_KEY=
IMAGEKIT_PRIVATE_KEY=
IMAGEKIT_URL_ENDPOINT=
```

#### Notes

* No secrets hard-coded
* Test environment may override values
* ImageKit defaults used only in tests

---

## 7. Product Model

### 7.1 `src/models/product.model.js`

```js
const mongoose = require('mongoose');

const productSchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,
    trim: true
  },

  description: {
    type: String,
    trim: true
  },

  price: {
    amount: {
      type: Number,
      required: true,
      min: 0
    },
    currency: {
      type: String,
      enum: ['INR', 'USD', 'EUR'],
      required: true
    }
  },

  seller: {
    type: mongoose.Schema.Types.ObjectId,
    required: true,
    ref: 'user'
  },

  images: [
    {
      url: String,
      thumbnail: String,
      id: String
    }
  ],

  stock: {
    type: Number,
    default: 0,
    min: 0
  }
}, { timestamps: true });

productSchema.index({ title: 'text', description: 'text' });

module.exports = mongoose.model('product', productSchema);
```

#### Why text index?

* Enables full-text search
* Supports ranking & relevance

---

## 8. Routing Layer

### 8.1 `src/routes/product.routes.js`

#### Required Imports

```js
const express = require('express');
const multer = require('multer');
const productController = require('../controllers/product.controller');
const createAuthMiddleware = require('../middlewares/auth.middleware');
const { createProductValidators } = require('../validators/product.validators');
```

#### Multer Configuration

```js
const upload = multer({ storage: multer.memoryStorage() });
```

**Reason:**
Images are uploaded directly to ImageKit — no disk writes.

---

### Routes

| Method | Path                   | Role          | Purpose           |
| ------ | ---------------------- | ------------- | ----------------- |
| POST   | `/api/products`        | admin, seller | Create product    |
| GET    | `/api/products`        | public        | List products     |
| GET    | `/api/products/:id`    | public        | Product detail    |
| PATCH  | `/api/products/:id`    | seller        | Update product    |
| DELETE | `/api/products/:id`    | seller        | Delete product    |
| GET    | `/api/products/seller` | seller        | Seller’s products |

---

## 9. Authentication Middleware

### 9.1 `src/middlewares/auth.middleware.js`

#### Purpose

JWT-based **role-aware access control**

#### Behavior

1. Reads token from:

   * `req.cookies.token`
   * `Authorization: Bearer <token>`
2. Verifies JWT
3. Checks role authorization
4. Attaches `req.user`

#### Failure Modes

| Status | Reason        |
| ------ | ------------- |
| 401    | No token      |
| 401    | Invalid token |
| 403    | Role mismatch |

---

## 10. Controller Layer

### 10.1 `src/controllers/product.controller.js`

#### Imports

```js
const productModel = require('../models/product.model');
const { uploadImage } = require('../services/imagekit.service');
const mongoose = require('mongoose');
const { publishToQueue } = require("../broker/borker");
```

---

### Controller Responsibilities

#### `createProduct(req, res)`

* Validate request body
* Parse multipart files
* Upload images to ImageKit
* Save product document
* Publish `PRODUCT_CREATED` event

---

#### `getProducts(req, res)`

* Pagination
* Text search
* Sorting
* Public access

---

#### `getProductById(req, res)`

* Validate ObjectId
* Fetch single product
* 404 handling

---

#### `updateProduct(req, res)`

* Seller ownership validation
* Partial updates
* Optional image updates

---

#### `deleteProduct(req, res)`

* Seller authorization
* Hard delete
* Publish `PRODUCT_DELETED`

---

#### `getProductsBySeller(req, res)`

* Seller-scoped query
* Requires auth

---

## 11. ImageKit Service

### 11.1 `src/services/imagekit.service.js`

```js
const ImageKit = require('imagekit');
const { v4: uuidv4 } = require("uuid");
```

#### Configuration

```js
const imagekit = new ImageKit({
  publicKey: process.env.IMAGEKIT_PUBLIC_KEY || 'test_public',
  privateKey: process.env.IMAGEKIT_PRIVATE_KEY || 'test_private',
  urlEndpoint: process.env.IMAGEKIT_URL_ENDPOINT || 'https://ik.imagekit.io/demo',
});
```

---

### `uploadImage({ buffer, folder })`

#### Responsibilities

* Generate unique filename
* Upload binary buffer
* Return normalized image metadata

#### Return Shape

```js
{
  url,
  thumbnail,
  id
}
```

---

## 12. Validation Layer

### 12.1 `src/validators/product.validators.js`

```js
const { body, validationResult } = require('express-validator');
```

#### Purpose

* Prevent invalid data from reaching controllers
* Centralize request validation

#### Typical Validations

* `title` required
* `price.amount` numeric
* `price.currency` enum
* Stock non-negative

---

## 13. Testing Setup (Jest)

### Goal

Test **POST /api/products** with:

* JWT auth
* Multer file uploads
* ImageKit mocking
* In-memory MongoDB

### Strategy

* Mock ImageKit upload
* Use `mongodb-memory-server`
* Use Supertest for HTTP assertions

---

## 14. package.json Scripts

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest --runInBand"
  }
}
```

---

## 15. Architectural Guarantees

✔ Stateless
✔ Testable
✔ RBAC-enabled
✔ External storage
✔ Event-driven ready
✔ Production-safe

---